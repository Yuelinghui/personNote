#ART与Dalvik对比

Android 4.4以上手机使用的是ART，而4.4以下使用的是Dalvik

##Dalvik

Dalvik是Google公司自己设计用于Android平台的虚拟机，是Android移动设备平台的核心组成部分之一。它可以支持已转换为`.dex`格式的Java应用程序的运行，`.dex`格式是专为Dalvik设计的一种压缩格式，适合内存和处理器速度有限的系统。

Dalvik 经过优化，允许在有限的内存中同时运行多个虚拟机的实例，并且每一个Dalvik 应用作为一个独立的Linux 进程执行。独立的进程可以防止在虚拟机崩溃的时候所有程序都被关闭。

在Dalvik下，应用每次运行的时候，字节码都需要通过即时编译器（just in time，JIT）转换为机器码，这会拖慢应用的运行效率。

###Dalvik和JVM有啥关系？
主要区别：
* Dalvik是基于寄存器的，而JVM是基于栈的。
* Dalvik运行dex文件，而JVM运行java字节码
* 自Android 2.2开始，Dalvik支持JIT（just-in-time，即时编译技术）。优化后的Dalvik较其他标准虚拟机存在一些不同特性:　
    1. 占用更少空间　
    2. 为简化翻译，常量池只使用32位索引　　
    3. 标准Java字节码实行8位堆栈指令,Dalvik使用16位指令集直接作用于局部变量。局部变量通常来自4位的“虚拟寄存器”区。这样减少了Dalvik的指令计数，提高了翻译速度。　
    4. 当Android启动时，Dalvik VM 监视所有的程序（APK），并且创建依存关系树，为每个程序优化代码并存储在Dalvik缓存中。Dalvik第一次加载后会生成Cache文件，以提供下次快速加载，所以第一次会很慢。
    5. Dalvik解释器采用预先算好的Goto地址，每个指令对内存的访问都在64字节边界上对齐。这样可以节省一个指令后进行查表的时间。为了强化功能, Dalvik还提供了快速翻译器（Fast Interpreter）。
    6. 一般来说,基于堆栈的机器必须使用指令才能从堆栈上的加载和操作数据,因此,相对基于寄存器的机器，它们需要更多的指令才能实现相同的性能。但是基于寄存器机器上的指令必须经过编码,因此,它们的指令往往更大。
    7. Dalvik虚拟机既不支持Java SE 也不支持Java ME类库(如：Java类,AWT和Swing都不支持)。 相反,它使用自己建立的类库（Apache Harmony Java的一个子集）。
    
##ART

即Android Runtime！

ART的机制与Dalvik不同。在ART环境中，应用在第一次安装的时候，字节码就会预先编译成机器码，使其成为真正的本地应用。这个过程叫做预编译（AOT,Ahead-Of-Time）。这样的话，应用的启动(首次)和执行都会变得更加快速。

###ART的优缺点

* 优点：
    1. 系统性能的显著提升
    2. 应用启动更快、运行更快、体验更流畅、触感反馈更及时
    3. 更长的电池续航能力
    4. 支持更低的硬件
* 缺点：
    1. 机器码占用的存储空间更大，字节码变为机器码之后，可能会增加10%-20%（不过在应用包中，可执行的代码常常只是一部分。比如最新的 Google+ APK 是 28.3 MB，但是代码只有 6.9 MB。）
    2. 应用的安装时间会变长

##两者的区别

Dalvik是执行的时候编译+运行，安装比较快，开启应用比较慢，应用占用空间小。在应用程序启动时，JIT通过进行连续的性能分析来优化程序代码的执行，在程序运行的过程中，Dalvik虚拟机在不断的进行将字节码编译成机器码的工作。

ART是安装的时候就编译好了，执行的时候直接就可以运行的，安装慢，开启应用快，占用空间大。ART引入了AOT这种预编译技术，在应用程序安装的过程中，ART就已经将所有的字节码重新编译成了机器码。应用程序运行过程中无需进行实时的编译工作，只需要进行直接调用.因此，ART极大的提高了应用程序的运行效率，同时也减少了手机的电量消耗，提高了移动设备的续航能力，在垃圾回收等机制上也有了较大的提升。

**相对于Dalvik虚拟机模式，ART模式下Android应用程序的安装需要消耗更多的时间，同时也会占用更大的储存空间（指内部储存，用于储存编译后的代码）,但节省了很多Dalvik虚拟机用于实时编译的时间**

