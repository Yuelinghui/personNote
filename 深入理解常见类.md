##深入理解常见类

###以“三板斧”解密RefBase，sp，wp

RefBase是Android中所有对象的始祖。在Android中，RefBase结合sp和wp，实现了一套通过引用计数的方法来控制对象生命周期的机制。

sp是strong pointer,而wp则是weak pointer。

####第一板斧--初识影子对象

```
class A : public RefBase
{
    // A没有自己的功能
}

int main()
{
    A* pA = new A;
    {
        sp<A> spA(pA);
        wp<A> wpA(pA);
    ...
    }
}
```

类A从RefBase中派生。RefBase构造函数中有一个mRefs，它是引用计数管理的关键类。

mRefs是从RefBase的内部类weakref_type中派生出来的。

new了一个A对象后，其实还new了一个weakref_impl对象，它就是**影子对象**，A为**实际对象。**

影子对象成员中有两个引用计数，一个强引用，一个若引用，它和对象生死有些许关联。

在构造一个实际对象的同时，还会悄悄地构造一个影子对象。

sp是一个模板类，它保存了pA的指针，并调用pA的incStrong。

在incStrong里，操作影子对象（mRefs），先增加弱引用计数，**原子操作，影子对象的弱引用计数加1**。再增加强引用计数，如果是第一次引用，会调用onFirstRef，派生类可以重载这个函数，完成一些初始化工作。

sp构造完成后，**在RefBase中的影子对象的强引用计数变为1，且弱引用计数也变为1。**

wp只有，影子对象的弱引用计数将增加1，所以现在弱引用计数为2，而强引用计数仍为1。另外，wp中有两个成员变量，一个保存实际对象，另一个保存影子对象。sp只有一个成员变量，用来保存实际对象，但这个实际对象内部已包含了对应的影子对象。